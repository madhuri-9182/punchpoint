options:
  logging: CLOUD_LOGGING_ONLY 
steps:
  # STEP 1 — Build image from Dockerfile
  - name: 'gcr.io/cloud-builders/docker'
    args: [
      'build',
      '-t', 'gcr.io/dynamic-now-438707-c1/punchpoint:$COMMIT_SHA',
      '-t', 'gcr.io/dynamic-now-438707-c1/punchpoint:latest',
      '.'
    ]

  # STEP 2 — Push image to Container Registry
  - name: 'gcr.io/cloud-builders/docker'
    args: [
      'push',
      'gcr.io/dynamic-now-438707-c1/punchpoint:$COMMIT_SHA'
    ]

  # STEP 3 — Setup GKE cluster (create if doesn't exist)
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        # Check if cluster exists, create if it doesn't
        if ! gcloud container clusters describe punchpoint-cluster \
          --region asia-south1 --project dynamic-now-438707-c1 2>/dev/null; then
          echo "Creating cluster..."
          gcloud container clusters create-auto punchpoint-cluster \
            --region asia-south1 \
            --project dynamic-now-438707-c1
        else
          echo "Cluster already exists, skipping creation."
        fi

  # STEP 4 — Authenticate to GKE
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    entrypoint: 'gcloud'
    args: [
      'container', 'clusters', 'get-credentials', 'punchpoint-cluster',
      '--region', 'asia-south1',
      '--project', 'dynamic-now-438707-c1'
    ]

 # STEP 6 — Deploy Kubernetes manifests
  - name: 'gcr.io/cloud-builders/kubectl'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        kubectl apply -f deployment.yaml
        kubectl apply -f service.yaml

images:
  - 'gcr.io/dynamic-now-438707-c1/punchpoint:$COMMIT_SHA'
